<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Katalog Kapsli</title>

  <!-- Czcionki Google -->
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      padding: 20px;
      background: #d2f5d2;
      margin: 0;
      position: relative;
    }

    .home-icon {
      position: absolute;
      top: 55px;
      left: 25px;
      font-size: 1.6em;
      text-decoration: none;
      color: #333;
      background: white;
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      z-index: 10;
    }

    h1 {
      font-family: 'Pacifico', cursive;
      text-align: center;
      font-size: 2.8em;
      padding: 40px 20px;
      border-radius: 25px;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      margin: 40px 0 30px;
    }

    .filter {
      background: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }

    .caps {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .cap {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .cap h3 {
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      max-width: 780px;
      margin: 0 auto;
    }

    .gallery img {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
    }

    #error-log {
      background: #ffdada;
      border: 1px solid red;
      padding: 10px;
      border-radius: 5px;
      display: none;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<a href="index.html" class="home-icon">üè†</a>
<h1>Kolekcja kapsli</h1>

<div id="error-log"></div>

<div class="filter">
  <label>Kraj:</label>
  <select id="country-select">
    <option value="all">Wszystkie</option>
  </select>

  <label>Browar:</label>
  <select id="letter-filter">
    <option value="all">Wszystkie</option>
  </select>
</div>

<div id="counter"></div>
<div class="caps" id="caps-container"></div>

<script>
/* ===== NORMALIZACJA NAZW BROWAR√ìW ===== */
function normalizeBreweryName(name) {
  const words = name.trim().split(/\s+/);

  if (
    words[0].toLowerCase() === 'browar' ||
    words[0].toLowerCase() === 'browary'
  ) {
    words.shift();
  }

  return words.join(' ');
}

/* ===== LITERA DO FILTRA ===== */
function getGroupLetter(name) {
  const normalized = normalizeBreweryName(name);
  return normalized[0]?.toUpperCase() || '?';
}

/* ===== IGNOROWANIE ROZSZERZE≈É OBRAZ√ìW + DWIE LOKALIZACJE ===== */
function getBaseName(path) {
  return path.replace(/\.[^/.]+$/, '');
}

function createImageIgnoreExtension(path) {
  const baseName = getBaseName(path);
  const extensions = ['jpg', 'jpeg', 'png', 'webp'];

  // KOLEJNO≈öƒÜ MA ZNACZENIE ‚Äì images_2 ma pierwsze≈Ñstwo
  const folders = ['images_2', 'images'];

  const img = document.createElement('img');
  let folderIndex = 0;
  let extIndex = 0;

  const tryNext = () => {
    if (folderIndex >= folders.length) return;

    img.src = `${folders[folderIndex]}/${baseName}.${extensions[extIndex]}`;

    extIndex++;
    if (extIndex >= extensions.length) {
      extIndex = 0;
      folderIndex++;
    }
  };

  img.onerror = tryNext;
  tryNext();

  return img;
}

async function loadCaps() {
  const container = document.getElementById('caps-container');
  const countrySelect = document.getElementById('country-select');
  const letterFilter = document.getElementById('letter-filter');
  const counter = document.getElementById('counter');
  const errorLog = document.getElementById('error-log');

  const showError = msg => {
    errorLog.style.display = 'block';
    errorLog.innerHTML += `<div>‚ö†Ô∏è ${msg}</div>`;
  };

  let caps;
  try {
    const response = await fetch('caps.json');
    caps = await response.json();
  } catch {
    showError('Nie uda≈Ço siƒô wczytaƒá caps.json');
    return;
  }

  /* ===== KRAJE ‚Äì SORT PL ===== */
  const countries = [...new Set(caps.map(c => c.country))]
    .sort((a, b) => a.localeCompare(b, 'pl'));

  countries.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    countrySelect.appendChild(opt);
  });

  /* ===== LITERY ‚Äì SORT PL, BEZ BROWAR ===== */
  const letters = [...new Set(caps.map(c => getGroupLetter(c.name)))]
    .sort((a, b) => a.localeCompare(b, 'pl'));

  letters.forEach(l => {
    const opt = document.createElement('option');
    opt.value = l;
    opt.textContent = l;
    letterFilter.appendChild(opt);
  });

  function render(selectedCountry = 'all', selectedLetter = 'all') {
    container.innerHTML = '';

    let filtered = selectedCountry === 'all'
      ? caps
      : caps.filter(c => c.country === selectedCountry);

    if (selectedLetter !== 'all') {
      filtered = filtered.filter(
        c => getGroupLetter(c.name) === selectedLetter
      );
    }

    counter.textContent = `≈ÅƒÖcznie kapsli: ${filtered.length}`;

    const groups = {};
    filtered.forEach(c => {
      if (!groups[c.name]) groups[c.name] = [];
      groups[c.name].push(c);
    });

    Object.keys(groups)
      .sort((a, b) =>
        normalizeBreweryName(a).localeCompare(
          normalizeBreweryName(b),
          'pl'
        )
      )
      .forEach(group => {
        const div = document.createElement('div');
        div.className = 'cap';

        const h3 = document.createElement('h3');
        h3.textContent = `${group} (${groups[group].length})`;
        div.appendChild(h3);

        const gallery = document.createElement('div');
        gallery.className = 'gallery';

        groups[group].forEach(c => {
          c.images.forEach(img => {
            const image = createImageIgnoreExtension(img.src || img);
            image.alt = group;
            gallery.appendChild(image);
          });
        });

        div.appendChild(gallery);
        container.appendChild(div);
      });
  }

  countrySelect.addEventListener('change', () =>
    render(countrySelect.value, letterFilter.value)
  );

  letterFilter.addEventListener('change', () =>
    render(countrySelect.value, letterFilter.value)
  );

  render();
}

loadCaps();
</script>

</body>
</html>
